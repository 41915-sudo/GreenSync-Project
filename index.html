<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>üåø GreenSync Duel ‚Äî Form ‚Üí Dashboard ‚Üí Insights ‚Üí Daily Scores</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Noto+Sans+Thai:wght@400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
<style>
  :root{
    --bg:#f5f7fa;--text:#1f2430;--muted:#667085;--card:#fff;--border:#e5e7eb;
    --primary:#10b981;--primary-light:#d1fae5;--primary-dark:#047857;
    --secondary:#8b5cf6;--accent:#f59e0b;
  }
  .theme-kid{--bg:#e0f7fa;--text:#01579b;--muted:#4dd0e1;--card:#fff;--border:#b2ebf2;--primary:#00bcd4;--primary-light:#b2ebf2;--primary-dark:#00838f;--secondary:#ff4081;--accent:#ffc107;}
  .theme-teen{--bg:#f3e5f5;--text:#4a148c;--muted:#8e24aa;--card:#fff;--border:#e1bee7;--primary:#9c27b0;--primary-light:#e1bee7;--primary-dark:#6a1b9a;--secondary:#ff9800;--accent:#4caf50;}
  .theme-adult{--bg:#f5f5f5;--text:#212121;--muted:#757575;--card:#fff;--border:#e0e0e0;--primary:#455a64;--primary-light:#cfd8dc;--primary-dark:#263238;--secondary:#607d8b;--accent:#ff5722;}
  .theme-cny{--bg:#fff9f9;--text:#b71c1c;--muted:#d32f2f;--card:#fff;--border:#ffcdd2;--primary:#d32f2f;--primary-light:#ffcdd2;--primary-dark:#b71c1c;--secondary:#ffc107;--accent:#4caf50;}
  .theme-valentine{--bg:#fff5f7;--text:#880e4f;--muted:#ad1457;--card:#fff;--border:#f8bbd9;--primary:#e91e63;--primary-light:#f8bbd9;--primary-dark:#ad1457;--secondary:#ec407a;--accent:#ab47bc;}
  .theme-newyear{--bg:#f0f8ff;--text:#0d47a1;--muted:#1565c0;--card:#fff;--border:#bbdefb;--primary:#0d47a1;--primary-light:#bbdefb;--primary-dark:#002171;--secondary:#ff6d00;--accent:#00c853;}

  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,"Noto Sans Thai",system-ui;transition:.3s}
  .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
  .h1{font-weight:700;font-size:28px}
  .muted{color:var(--muted)}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 6px 18px rgba(0,0,0,.06);margin-bottom:16px;transition:.3s}
  .hd{padding:14px 16px;border-bottom:1px solid var(--border);font-weight:600;background:var(--primary-light);color:var(--primary-dark)}
  .bd{padding:14px 16px}
  label{display:block;margin-bottom:6px;font-size:14px}
  input,select{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;transition:.2s}
  input:focus,select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px var(--primary-light)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .btn{display:inline-flex;gap:8px;align-items:center;border-radius:999px;padding:10px 16px;border:1px solid var(--primary);background:var(--primary);color:#fff;cursor:pointer;font-weight:600;transition:.2s}
  .btn:hover{background:var(--primary-dark);transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,.1)}
  .btn.ghost{background:#fff;color:var(--primary-dark)}
  .btn.danger{background:#ef4444;border-color:#ef4444;color:#fff}
  .btn.danger:hover{background:#dc2626}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  @media(max-width:900px){.row{grid-template-columns:1fr}.grid2{grid-template-columns:1fr}}
  .kpi{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:8px}
  .kpi .it{background:#f8fafc;border:1px solid var(--border);border-radius:12px;padding:8px 10px}
  .kpi .v{font-weight:700}
  .hearts{font-size:28px;line-height:1.1;color:#e91e63;word-break:break-word}
  .special-hearts{font-size:24px;line-height:1.1;word-break:break-word;margin-top:4px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:6px 8px;border-bottom:1px solid var(--border);font-size:13px}
  thead th{background:#f8fafc}
  .flex{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;background:var(--primary-light);color:var(--primary-dark);font-weight:600;font-size:12px}
  .err{color:#b91c1c;font-weight:600}
  .ok{color:#047857;font-weight:600}
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#fff}
  .sub{font-size:12px;color:var(--muted)}
  .sp{display:inline-flex;align-items:center;gap:8px}
  .dot{width:10px;height:10px;border-radius:999px;background:#9ca3af;display:inline-block}
  .dot.ok{background:#10b981}.dot.fail{background:#ef4444}.dot.load{background:#f59e0b}
  .spinner{width:18px;height:18px;border:3px solid #e5e7eb;border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  .hero{display:flex;align-items:center;gap:12px}
  .mascot{width:64px;height:64px}
  .teamBadge{display:flex;align-items:center;gap:8px}
  .teamIcon{width:18px;height:18px}

  /* Team name editor */
  .team-name-editor { display: flex; gap: 8px; align-items: center; }
  .team-name { cursor: pointer; padding: 4px 8px; border-radius: 6px; transition: background 0.2s; }
  .team-name:hover { background: var(--primary-light); }
  .team-name-input { width: 120px; padding: 4px 8px; font-size: 14px; }

  /* cartoon vibe */
  .theme-kid .mascot, .theme-teen .mascot { animation: bob 2.5s ease-in-out infinite; }
  @keyframes bob { 0%,100%{ transform:translateY(0) } 50%{ transform:translateY(-3px) } }
  .theme-kid body{ background:linear-gradient(180deg,#e0f7fa 0%, #f5f7fa 100%) }
  .theme-teen body{ background:linear-gradient(180deg,#f3e5f5 0%, #f5f7fa 100%) }
  
  /* AI Advice Styles */
  .ai-advice { 
    background: #f8fafc; 
    border-left: 4px solid var(--primary); 
    padding: 12px; 
    border-radius: 8px; 
    margin-top: 12px; 
    transition: all 0.3s ease;
  }
  .ai-advice.collapsed {
    max-height: 60px;
    overflow: hidden;
    cursor: pointer;
  }
  .ai-advice.expanded {
    max-height: 500px;
    overflow-y: auto;
  }
  .ai-advice-header { 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    margin-bottom: 8px; 
    cursor: pointer;
  }
  .ai-advice-header h4 { 
    margin: 0; 
    color: var(--primary-dark); 
    display: flex; 
    align-items: center; 
    gap: 8px;
  }
  .ai-advice-toggle {
    background: none;
    border: none;
    color: var(--primary);
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
    transition: background 0.2s;
  }
  .ai-advice-toggle:hover {
    background: var(--primary-light);
  }
  .ai-advice-content { 
    white-space: pre-line; 
    line-height: 1.5; 
    font-size: 14px;
  }
  .ai-advice.collapsed .ai-advice-content {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  .ai-loading { 
    display: flex; 
    align-items: center; 
    gap: 8px; 
    color: var(--muted); 
  }

  /* Status badges */
  .status-badge { display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; }
  .status-excellent { background: #dcfce7; color: #166534; }
  .status-good { background: #dbeafe; color: #1e40af; }
  .status-fair { background: #fef3c7; color: #92400e; }
  .status-poor { background: #fecaca; color: #991b1b; }
  .status-critical { background: #fecaca; color: #991b1b; }

  /* Scrollbar for AI advice */
  .ai-advice::-webkit-scrollbar {
    width: 6px;
  }
  .ai-advice::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
  }
  .ai-advice::-webkit-scrollbar-thumb {
    background: var(--primary);
    border-radius: 3px;
  }
  .ai-advice::-webkit-scrollbar-thumb:hover {
    background: var(--primary-dark);
  }

  /* Daily Scores Styles */
  .daily-stats-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    margin-bottom: 16px;
  }
  .daily-stat-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 12px;
  }
  .daily-stat-value {
    font-size: 24px;
    font-weight: 700;
    margin: 8px 0;
  }
  .daily-stat-label {
    font-size: 12px;
    color: var(--muted);
  }
  .win-badge {
    background: #dcfce7;
    color: #166534;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
  }
  .loss-badge {
    background: #fecaca;
    color: #991b1b;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
  }
  .tie-badge {
    background: #fef3c7;
    color: #92400e;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
  }
</style>
</head>
<body>
<div class="wrap">
  <!-- Header -->
  <div class="card">
    <div class="bd flex" style="justify-content:space-between">
      <div class="hero">
        <svg class="mascot" viewBox="0 0 128 128" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <defs>
            <linearGradient id="g1" x1="0" x2="0" y1="0" y2="1">
              <stop offset="0%" stop-opacity="1" stop-color="#34d399"/>
              <stop offset="100%" stop-opacity="1" stop-color="#10b981"/>
            </linearGradient>
          </defs>
          <circle cx="64" cy="64" r="62" fill="#ecfdf5" stroke="#a7f3d0" stroke-width="4"/>
          <path d="M64 72c-14 0-22-10-22-22 10 0 18 4 22 10 4-6 12-10 22-10 0 12-8 22-22 22z" fill="url(#g1)"/>
          <rect x="36" y="76" width="56" height="26" rx="8" fill="#f59e0b"/>
          <rect x="42" y="82" width="44" height="6" rx="3" fill="#fed7aa"/>
          <rect x="48" y="92" width="32" height="6" rx="3" fill="#fed7aa"/>
        </svg>
        <div>
          <div class="h1">üåø GreenSync ‚Äî Duel Mode</div>
          <div class="muted">‡∏Å‡∏£‡∏≠‡∏Å‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå ‚Üí ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î 2 ‡∏Å‡∏£‡∏∞‡∏ñ‡∏≤‡∏á ‚Üí ‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å ‚Üí ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</div>
        </div>
      </div>
      <div class="flex">
        <button class="btn ghost" id="btnEditProfile" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå" style="display:none"><i class="fa-solid fa-user-pen"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</button>
        <select id="theme" title="‡∏ò‡∏µ‡∏°">
          <option value="default">‡∏ò‡∏µ‡∏°‡∏õ‡∏Å‡∏ï‡∏¥</option>
          <option value="kid">‡∏ò‡∏µ‡∏°‡πÄ‡∏î‡πá‡∏Å</option>
          <option value="teen">‡∏ò‡∏µ‡∏°‡∏ß‡∏±‡∏¢‡∏£‡∏∏‡πà‡∏ô</option>
          <option value="adult">‡∏ò‡∏µ‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà</option>
          <option value="cny">‡∏ò‡∏µ‡∏°‡∏ï‡∏£‡∏∏‡∏©‡∏à‡∏µ‡∏ô</option>
          <option value="valentine">‡∏ò‡∏µ‡∏°‡∏ß‡∏≤‡πÄ‡∏•‡∏ô‡πÑ‡∏ó‡∏ô‡πå</option>
          <option value="newyear">‡∏ò‡∏µ‡∏°‡∏õ‡∏µ‡πÉ‡∏´‡∏°‡πà</option>
        </select>
        <span class="badge"><i class="fa-solid fa-clock"></i> <span id="nowTH">‚Äî</span></span>
      </div>
    </div>
  </div>

  <!-- NAV -->
  <div class="flex" style="margin:0 0 12px 2px">
    <button class="btn ghost" id="navForm"><i class="fa-regular fa-rectangle-list"></i> ‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
    <button class="btn ghost" id="navDash"><i class="fa-solid fa-gauge"></i> ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</button>
    <button class="btn ghost" id="navInsight"><i class="fa-solid fa-heart-pulse"></i> ‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å</button>
    <button class="btn ghost" id="navDailyScores" style="display:none"><i class="fa-solid fa-trophy"></i> ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</button>
    <span class="muted" id="profileBadge" style="display:none"><i class="fa-solid fa-circle-check"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡πâ‡∏ß</span>
    <button class="btn danger ghost" id="btnReset" style="margin-left:auto"><i class="fa-solid fa-rotate-left"></i> ‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
    <button class="btn danger ghost" id="btnClearURL" style="display:none"><i class="fa-solid fa-broom"></i> ‡∏•‡πâ‡∏≤‡∏á URL</button>
  </div>

  <!-- FORM -->
  <div class="card" id="secForm">
    <div class="hd">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå & ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</div>
    <div class="bd">
      <div class="row">
        <div>
          <label>Web App URL (‡∏£‡∏ß‡∏°‡∏ó‡∏µ‡∏° A/B) ‚Äî ‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢ /exec</label>
          <input id="webapp" placeholder="https://script.google.com/macros/s/DEPLOYMENT_ID/exec">
        </div>
        <div>
          <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ñ‡∏ß (limit)</label>
          <select id="limit"><option>10</option><option>30</option><option selected>50</option><option>100</option></select>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div>
          <label>‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î Web App ‡πÅ‡∏¢‡∏Å‡∏ó‡∏µ‡∏° (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö) ‚Äî ‡∏ó‡∏µ‡∏° A</label>
          <input id="webappA" placeholder="‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ URL ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô">
        </div>
        <div>
          <label>‡∏ó‡∏µ‡∏° B</label>
          <input id="webappB" placeholder="‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ URL ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô">
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div>
          <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡∏° A</label>
          <input id="teamNameA" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡∏° A" value="‡∏ó‡∏µ‡∏° A">
        </div>
        <div>
          <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡∏° B</label>
          <input id="teamNameB" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡∏° B" value="‡∏ó‡∏µ‡∏° B">
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div>
          <label>‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ</label>
          <input id="plant" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏¢‡∏≤‡∏á‡∏≠‡∏¥‡∏ô‡πÄ‡∏î‡∏µ‡∏¢ / ‡∏°‡∏≠‡∏ô‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡πà‡∏≤" value="‡∏°‡∏≠‡∏ô‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡πà‡∏≤">
        </div>
        <div>
          <label>‡∏Ç‡∏ô‡∏≤‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏π‡∏Å</label>
          <input id="size" placeholder="‡πÄ‡∏ä‡πà‡∏ô 2 x 3 ‡πÄ‡∏°‡∏ï‡∏£" value="1.5 x 2 ‡πÄ‡∏°‡∏ï‡∏£">
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div>
          <label>‡πÅ‡∏™‡∏á</label>
          <select id="lightCond"><option>‡∏û‡∏≠‡∏°‡∏≤‡∏Å</option><option selected>‡∏û‡∏≠‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</option><option>‡∏ô‡πâ‡∏≠‡∏¢/‡∏≠‡∏±‡∏ö‡πÅ‡∏™‡∏á</option></select>
        </div>
        <div>
          <label>‡∏Å‡∏≤‡∏£‡∏ñ‡πà‡∏≤‡∏¢‡πÄ‡∏ó‡∏≠‡∏≤‡∏Å‡∏≤‡∏®</label>
          <select id="airflow"><option>‡πÇ‡∏õ‡∏£‡πà‡∏á</option><option selected>‡∏û‡∏≠‡πÉ‡∏ä‡πâ</option><option>‡∏≠‡∏±‡∏ö</option></select>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div>
          <label>‡πÅ‡∏≠‡∏£‡πå</label>
          <select id="ac"><option>‡∏ï‡∏•‡∏≠‡∏î‡∏ß‡∏±‡∏ô</option><option selected>‡∏ö‡∏≤‡∏á‡πÄ‡∏ß‡∏•‡∏≤</option><option>‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î</option></select>
        </div>
        <div>
          <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡∏•‡∏π‡∏Å (‡πÉ‡∏ä‡πâ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏£‡πà‡∏ß‡∏° A/B)</label>
          <input id="name" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏£‡∏π‡∏£‡∏±‡∏ä‡∏û‡∏•" value="‡∏ó‡∏µ‡∏° GreenSync">
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <div>
          <label>‡∏£‡∏≠‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï (‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)</label>
          <select id="interval"><option>10</option><option selected>20</option><option>30</option><option>60</option></select>
        </div>
        <div>
          <label>‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏î‡∏™‡∏≠‡∏ö (‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ß‡πá‡∏ö‡πÅ‡∏≠‡∏õ)</label>
          <select id="demo"><option value="off" selected>‡∏õ‡∏¥‡∏î</option><option value="on">‡πÄ‡∏õ‡∏¥‡∏î</option></select>
        </div>
      </div>

      <div style="margin-top:12px" class="flex">
        <button class="btn" id="btnStart"><i class="fa-solid fa-play"></i> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô ‚ûú ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</button>
        <span id="status" class="muted sp"><span class="dot" id="dot"></span><span id="statusText"></span></span>
        <button class="btn ghost" id="btnTest"><i class="fa-solid fa-plug"></i> ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</button>
      </div>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div class="card" id="secDash" style="display:none">
    <div class="hd">‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î 2 ‡∏Å‡∏£‡∏∞‡∏ñ‡∏≤‡∏á (<span id="teamALabel">‡∏ó‡∏µ‡∏° A</span> vs <span id="teamBLabel">‡∏ó‡∏µ‡∏° B</span>)</div>
    <div class="bd grid2">
      <!-- LEFT -->
      <div>
        <div class="flex" style="justify-content:space-between">
          <div class="teamBadge">
            <svg class="teamIcon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="#86efac"/><path d="M12 6c-3 0-4 2-4 4 2 0 3 .5 4 2 1.1-1.5 2-2 4-2 0-2-1-4-4-4z" fill="#16a34a"/></svg>
            <div class="muted team-name-editor">
              <span class="team-name" id="teamANameDisplay">‡∏ó‡∏µ‡∏° A</span>
              <input type="text" class="team-name-input" id="teamANameInput" style="display:none" maxlength="20">
            </div>
          </div>
          <div class="badge"><i class="fa-solid fa-database"></i> <span id="dsA">‚Äî</span></div>
        </div>
        <div class="kpi" style="margin-top:8px">
          <div class="it"><div>Temp (¬∞C)</div><div class="v" id="a_temp">-</div></div>
          <div class="it"><div>Humid (%)</div><div class="v" id="a_hum">-</div></div>
          <div class="it"><div>Soil (%)</div><div class="v" id="a_soil">-</div></div>
          <div class="it"><div>Light (%)</div><div class="v" id="a_light">-</div></div>
        </div>
        <div style="margin-top:8px">
          <div class="flex">
            <span>‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ:</span>
            <span id="a_status" class="status-badge status-fair">‚Äî</span>
          </div>
          <div class="hearts" id="a_hearts">‚Äî</div>
          <div class="special-hearts" id="a_special_hearts"></div>
        </div>
        <div class="muted" id="a_advice" style="margin-top:6px">‚Äî</div>
        <table style="margin-top:10px">
          <thead><tr><th style="text-align:left">‡πÄ‡∏ß‡∏•‡∏≤</th><th>Temp</th><th>RH</th><th>Soil</th><th>Light</th></tr></thead>
          <tbody id="a_tbl"></tbody>
        </table>
      </div>

      <!-- RIGHT -->
      <div>
        <div class="flex" style="justify-content:space-between">
          <div class="teamBadge">
            <svg class="teamIcon" viewBox="0 0 24 24"><rect x="2" y="2" width="20" height="20" rx="6" fill="#93c5fd"/><path d="M12 6c-3 0-4 2-4 4 2 0 3 .5 4 2 1.1-1.5 2-2 4-2 0-2-1-4-4-4z" fill="#2563eb"/></svg>
            <div class="muted team-name-editor">
              <span class="team-name" id="teamBNameDisplay">‡∏ó‡∏µ‡∏° B</span>
              <input type="text" class="team-name-input" id="teamBNameInput" style="display:none" maxlength="20">
            </div>
          </div>
          <div class="badge"><i class="fa-solid fa-database"></i> <span id="dsB">‚Äî</span></div>
        </div>
        <div class="kpi" style="margin-top:8px">
          <div class="it"><div>Temp (¬∞C)</div><div class="v" id="b_temp">-</div></div>
          <div class="it"><div>Humid (%)</div><div class="v" id="b_hum">-</div></div>
          <div class="it"><div>Soil (%)</div><div class="v" id="b_soil">-</div></div>
          <div class="it"><div>Light (%)</div><div class="v" id="b_light">-</div></div>
        </div>
        <div style="margin-top:8px">
          <div class="flex">
            <span>‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ:</span>
            <span id="b_status" class="status-badge status-fair">‚Äî</span>
          </div>
          <div class="hearts" id="b_hearts">‚Äî</div>
          <div class="special-hearts" id="b_special_hearts"></div>
        </div>
        <div class="muted" id="b_advice" style="margin-top:6px">‚Äî</div>
        <table style="margin-top:10px">
          <thead><tr><th style="text-align:left">‡πÄ‡∏ß‡∏•‡∏≤</th><th>Temp</th><th>RH</th><th>Soil</th><th>Light</th></tr></thead>
          <tbody id="b_tbl"></tbody>
        </table>
      </div>
    </div>
    <div class="bd" style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn" id="btnGoInsights"><i class="fa-solid fa-heart-pulse"></i> ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å</button>
      <button class="btn ghost" id="btnRefresh"><i class="fa-solid fa-rotate"></i> ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</button>
      <button class="btn ghost" id="btnEditTeams"><i class="fa-solid fa-pen-to-square"></i> ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡∏°</button>
      <button class="btn ghost" id="btnQuickHearts"><i class="fa-solid fa-heart"></i> ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏´‡∏±‡∏ß‡πÉ‡∏à‡πÄ‡∏£‡πá‡∏ß</button>
    </div>
  </div>

  <!-- INSIGHTS -->
  <div class="card" id="secInsights" style="display:none">
    <div class="hd">‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å: ‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏™‡∏∞‡∏™‡∏° + ‡∏™‡∏¥‡πà‡∏á‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏° & ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</div>
    <div class="bd">
      <div class="chips">
        <span class="chip">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô = ‡∏£‡∏π‡∏õ‡∏´‡∏±‡∏ß‡πÉ‡∏à (1‚Äì10)</span>
        <span class="chip">PM2.5 ‡πÉ‡∏ä‡πâ ¬µg/m¬≥</span>
      </div>
      <div style="margin:12px 0">
        <canvas id="chartHearts" height="120"></canvas>
      </div>

      <div class="grid2" style="margin-top:12px">
        <div class="card" style="margin:0">
          <div class="hd"><span id="healthTeamA">‡∏ó‡∏µ‡∏° A</span> ‚Äî ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
          <div class="bd">
            <div id="healthA">‚Äî</div>
            <div id="aiAdviceA" class="ai-advice collapsed">
              <div class="ai-advice-header">
                <h4><i class="fa-solid fa-robot"></i> ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏à‡∏≤‡∏Å AI</h4>
                <button class="ai-advice-toggle" title="‡∏û‡∏±‡∏ö/‡∏Ç‡∏¢‡∏≤‡∏¢">
                  <i class="fa-solid fa-chevron-down"></i>
                </button>
              </div>
              <div id="aiAdviceContentA" class="ai-advice-content"></div>
            </div>
          </div>
        </div>
        <div class="card" style="margin:0">
          <div class="hd"><span id="healthTeamB">‡∏ó‡∏µ‡∏° B</span> ‚Äî ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
          <div class="bd">
            <div id="healthB">‚Äî</div>
            <div id="aiAdviceB" class="ai-advice collapsed">
              <div class="ai-advice-header">
                <h4><i class="fa-solid fa-robot"></i> ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏à‡∏≤‡∏Å AI</h4>
                <button class="ai-advice-toggle" title="‡∏û‡∏±‡∏ö/‡∏Ç‡∏¢‡∏≤‡∏¢">
                  <i class="fa-solid fa-chevron-down"></i>
                </button>
              </div>
              <div id="aiAdviceContentB" class="ai-advice-content"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="grid2" style="margin-top:12px">
        <div>
          <div class="h1" style="font-size:18px;margin:0 0 6px">‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</div>
          <div id="dailyTable" class="sub">‚Äî</div>
        </div>
        <div>
          <div class="h1" style="font-size:18px;margin:0 0 6px">‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</div>
          <div id="weeklyTable" class="sub">‚Äî</div>
        </div>
      </div>

      <div class="flex" style="margin-top:12px">
        <button class="btn ghost" id="btnBackDash"><i class="fa-solid fa-gauge"></i> ‡∏Å‡∏•‡∏±‡∏ö‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</button>
        <button class="btn" id="btnGetAIAdvice"><i class="fa-solid fa-robot"></i> ‡∏Ç‡∏≠‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏à‡∏≤‡∏Å AI</button>
        <button class="btn" id="btnGoDailyScores"><i class="fa-solid fa-trophy"></i> ‡∏î‡∏π‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</button>
      </div>
    </div>
  </div>

  <!-- DAILY SCORES DASHBOARD -->
  <div class="card" id="secDailyScores" style="display:none">
    <div class="hd">‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</div>
    <div class="bd">
      <div class="flex" style="justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <div>
          <div class="h1" style="font-size: 24px; margin: 0;">üèÜ ‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</div>
          <div class="muted">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏∏‡∏Å‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏∑‡∏ô</div>
        </div>
        <div class="flex">
          <button class="btn ghost" id="btnManualSave"><i class="fa-solid fa-floppy-disk"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
          <button class="btn" id="btnBackToInsightsFromDaily"><i class="fa-solid fa-arrow-left"></i> ‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å</button>
        </div>
      </div>

      <!-- Statistics Summary -->
      <div class="grid2" style="margin-bottom: 20px;">
        <div class="card" style="margin: 0;">
          <div class="hd" id="dailyTeamALabel">‡∏ó‡∏µ‡∏° A - ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</div>
          <div class="bd">
            <div id="teamAStats" class="muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
          </div>
        </div>
        <div class="card" style="margin: 0;">
          <div class="hd" id="dailyTeamBLabel">‡∏ó‡∏µ‡∏° B - ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</div>
          <div class="bd">
            <div id="teamBStats" class="muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
          </div>
        </div>
      </div>

      <!-- Daily Scores Chart -->
      <div class="card" style="margin-bottom: 16px;">
        <div class="hd">üìà ‡∏Å‡∏£‡∏≤‡∏ü‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</div>
        <div class="bd">
          <canvas id="chartDailyScores" height="200"></canvas>
        </div>
      </div>

      <!-- Daily Scores Table -->
      <div class="card">
        <div class="hd">üìä ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</div>
        <div class="bd">
          <div style="overflow-x: auto;">
            <table style="width: 100%;">
              <thead>
                <tr>
                  <th style="text-align: left;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                  <th>‡∏ó‡∏µ‡∏°</th>
                  <th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</th>
                  <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</th>
                  <th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</th>
                  <th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î</th>
                  <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                </tr>
              </thead>
              <tbody id="dailyScoresTable">
                <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏î‡∏¢ JavaScript -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="flex" style="margin-top: 16px; justify-content: space-between;">
        <div class="muted" id="lastUpdateText">‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: -</div>
        <button class="btn ghost" id="btnRefreshDaily"><i class="fa-solid fa-rotate"></i> ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
      </div>
    </div>
  </div>
</div>

<script>
// ===== Configuration =====
const WEBAPP_URL = "";

// ===== Helpers =====
const $  = s => document.querySelector(s);
const tz = 'Asia/Bangkok';
const byId = id => document.getElementById(id);
const setTextSafe = (id, text)=>{ const el = byId(id); if(el) el.textContent = text; };
const bind = (id, ev, fn)=>{ const el = byId(id); if(el) el.addEventListener(ev, fn); else console.warn('Missing element:', id); };
const fmtTime = iso => !iso?'-': new Date(iso).toLocaleString('th-TH',{timeZone:tz,hour:'2-digit',minute:'2-digit',day:'2-digit',month:'short'});
const fmtDate = iso => !iso?'-': new Date(iso).toLocaleDateString('th-TH',{timeZone:tz});
const safeNum = v => { const n = Number(String(v).replace(/,/g,'')); return isFinite(n)? n:null; };
const nowTick = ()=> setTextSafe('nowTH', new Date().toLocaleString('th-TH',{ timeZone: tz }));
function onReady(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }

// ===== Theme & local persistence =====
onReady(()=>{
  setInterval(nowTick,1000); nowTick();
  const themeSel = byId('theme');
  if(themeSel){
    const saved = localStorage.getItem('theme')||'default';
    themeSel.value = saved;
    applyTheme(saved);
    themeSel.addEventListener('change',e=>applyTheme(e.target.value));
  }
  
  // Load all settings including team names
  ['webapp','webappA','webappB','limit','plant','size','lightCond','airflow','ac','name','interval','demo','teamNameA','teamNameB'].forEach(id=>{
    const el = byId(id); if(!el) return;
    const v = localStorage.getItem('gs_'+id); 
    if(v !== null) {
      el.value = v;
      // Update team name displays if they exist
      if (id === 'teamNameA' && byId('teamANameDisplay')) {
        byId('teamANameDisplay').textContent = v || '‡∏ó‡∏µ‡∏° A';
        byId('teamALabel').textContent = v || '‡∏ó‡∏µ‡∏° A';
        byId('healthTeamA').textContent = v || '‡∏ó‡∏µ‡∏° A';
        byId('dailyTeamALabel').textContent = `${v || '‡∏ó‡∏µ‡∏° A'} - ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥`;
      }
      if (id === 'teamNameB' && byId('teamBNameDisplay')) {
        byId('teamBNameDisplay').textContent = v || '‡∏ó‡∏µ‡∏° B';
        byId('teamBLabel').textContent = v || '‡∏ó‡∏µ‡∏° B';
        byId('healthTeamB').textContent = v || '‡∏ó‡∏µ‡∏° B';
        byId('dailyTeamBLabel').textContent = `${v || '‡∏ó‡∏µ‡∏° B'} - ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥`;
      }
    }
    el.addEventListener('change',e=> {
      localStorage.setItem('gs_'+id, e.target.value);
      // Update team name displays in real-time
      if (id === 'teamNameA') updateTeamName('A', e.target.value);
      if (id === 'teamNameB') updateTeamName('B', e.target.value);
    });
  });

  // Show Clear URL button if profile is already saved
  if (localStorage.getItem('gs_profile_done') === '1') {
    byId('btnClearURL').style.display = 'inline-flex';
    byId('navDailyScores').style.display = 'inline-flex';
  }

  // Initialize AI advice toggle functionality
  initializeAIToggle();
});

const applyTheme = v => { document.body.className=''; if(v && v!=='default') document.body.classList.add('theme-'+v); localStorage.setItem('theme',v||'default'); };

// ===== AI Advice Toggle System =====
function initializeAIToggle() {
  document.addEventListener('click', function(e) {
    if (e.target.closest('.ai-advice-header') || e.target.closest('.ai-advice-toggle')) {
      const aiAdvice = e.target.closest('.ai-advice');
      if (aiAdvice) {
        toggleAIAdvice(aiAdvice);
      }
    }
  });
}

function toggleAIAdvice(aiAdviceElement) {
  const isCollapsed = aiAdviceElement.classList.contains('collapsed');
  const toggleBtn = aiAdviceElement.querySelector('.ai-advice-toggle i');
  
  if (isCollapsed) {
    aiAdviceElement.classList.remove('collapsed');
    aiAdviceElement.classList.add('expanded');
    toggleBtn.className = 'fa-solid fa-chevron-up';
  } else {
    aiAdviceElement.classList.remove('expanded');
    aiAdviceElement.classList.add('collapsed');
    toggleBtn.className = 'fa-solid fa-chevron-down';
  }
}

// ===== Team Name Management =====
function updateTeamName(team, name) {
  const displayName = name || (team === 'A' ? '‡∏ó‡∏µ‡∏° A' : '‡∏ó‡∏µ‡∏° B');
  byId(`team${team}NameDisplay`).textContent = displayName;
  byId(`team${team}Label`).textContent = displayName;
  byId(`healthTeam${team}`).textContent = displayName;
  byId(`dailyTeam${team}Label`).textContent = `${displayName} - ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥`;
}

function setupTeamNameEditing() {
  // Team A
  const teamANameDisplay = byId('teamANameDisplay');
  const teamANameInput = byId('teamANameInput');
  teamANameDisplay.addEventListener('click', () => {
    teamANameDisplay.style.display = 'none';
    teamANameInput.style.display = 'block';
    teamANameInput.value = teamANameDisplay.textContent;
    teamANameInput.focus();
    teamANameInput.select();
  });
  teamANameInput.addEventListener('blur', () => { saveTeamName('A', teamANameInput.value); });
  teamANameInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') saveTeamName('A', teamANameInput.value); });

  // Team B
  const teamBNameDisplay = byId('teamBNameDisplay');
  const teamBNameInput = byId('teamBNameInput');
  teamBNameDisplay.addEventListener('click', () => {
    teamBNameDisplay.style.display = 'none';
    teamBNameInput.style.display = 'block';
    teamBNameInput.value = teamBNameDisplay.textContent;
    teamBNameInput.focus();
    teamBNameInput.select();
  });
  teamBNameInput.addEventListener('blur', () => { saveTeamName('B', teamBNameInput.value); });
  teamBNameInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') saveTeamName('B', teamBNameInput.value); });
}

function saveTeamName(team, name) {
  const displayName = name.trim() || (team === 'A' ? '‡∏ó‡∏µ‡∏° A' : '‡∏ó‡∏µ‡∏° B');
  const inputId = `teamName${team}`;
  const displayEl = byId(`team${team}NameDisplay`);
  const inputEl = byId(`team${team}NameInput`);
  updateTeamName(team, displayName);
  const formInput = byId(inputId); if (formInput) formInput.value = displayName;
  localStorage.setItem('gs_' + inputId, displayName);
  displayEl.style.display = 'block'; inputEl.style.display = 'none';
}

// ===== Reset & Clear URL =====
function resetAllSettings() {
  if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°? ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ')) {
    const keys = [
      'gs_profile_done','gs_last_urlA','gs_last_urlB','gs_last_limit',
      'gs_last_interval','gs_last_demo','gs_webapp','gs_webappA','gs_webappB',
      'gs_limit','gs_plant','gs_size','gs_lightCond','gs_airflow','gs_ac',
      'gs_name','gs_interval','gs_demo','gs_teamNameA','gs_teamNameB'
    ];
    keys.forEach(key => localStorage.removeItem(key));
    byId('webapp').value = ''; byId('webappA').value = ''; byId('webappB').value = '';
    byId('limit').value = '50'; byId('teamNameA').value = '‡∏ó‡∏µ‡∏° A'; byId('teamNameB').value = '‡∏ó‡∏µ‡∏° B';
    byId('plant').value = '‡∏°‡∏≠‡∏ô‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡πà‡∏≤'; byId('size').value = '1.5 x 2 ‡πÄ‡∏°‡∏ï‡∏£';
    byId('lightCond').value = '‡∏û‡∏≠‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì'; byId('airflow').value = '‡∏û‡∏≠‡πÉ‡∏ä‡πâ'; byId('ac').value = '‡∏ö‡∏≤‡∏á‡πÄ‡∏ß‡∏•‡∏≤';
    byId('name').value = '‡∏ó‡∏µ‡∏° GreenSync'; byId('interval').value = '20'; byId('demo').value = 'off';
    updateTeamName('A','‡∏ó‡∏µ‡∏° A'); updateTeamName('B','‡∏ó‡∏µ‡∏° B');
    show('secForm'); byId('navForm').style.display='inline-flex';
    byId('btnEditProfile').style.display='none'; byId('profileBadge').style.display='none'; 
    byId('btnClearURL').style.display='none'; byId('navDailyScores').style.display='none';
    setStatus('', ''); alert('‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
  }
}
function clearURLSettings() {
  if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á URL ‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?')) {
    localStorage.removeItem('gs_last_urlA'); localStorage.removeItem('gs_last_urlB'); localStorage.removeItem('gs_profile_done');
    show('secForm'); byId('navForm').style.display='inline-flex';
    byId('btnEditProfile').style.display='none'; byId('profileBadge').style.display='none'; 
    byId('btnClearURL').style.display='none'; byId('navDailyScores').style.display='none';
    setStatus('ok','‡∏•‡πâ‡∏≤‡∏á URL ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à - ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà');
  }
}

// ===== Column adapters =====
const COLS = {
  ts:   ['Timestamp (Asia/Bangkok)','Timestamp','Timestamp (Asia)','time','Time'],
  tC:   ['Temperature (¬∞C)','Temperature (¬∞C','AirTemp_C','Temp_C','Temp','Temperature'],
  rh:   ['Air Humidity (%)','Humid (%)','AirHumid_%RH','Humidity'],
  soil: ['Soil Moisture (%)','Soil Moisture (%','SoilMoist_%','Soil'],
  light:['Light (%)','Light_%','Light'],
  pm25: ['PM2.5 (¬µg/m¬≥)','PM2.5 (Œºg/m¬≥)','PM2_5','pm25','PM2.5'],
  uv:   ['UV Index','UV','UV_Index']
};
const SCORE = { 
  score:['Score_1_10','Score','Score1_10'], 
  advice:['Advice','AI_Advice','Note'], 
  ts:['Timestamp','Timestamp (Asia/Bangkok)','time'],
  hearts:['Hearts','hearts'],
  special_hearts:['SpecialHearts','special_hearts'],
  status:['Status','status']
};
const pick = (row, keys)=>{ for(const k of keys){ if(row && row[k]!=null && row[k]!=='' && row[k]!==undefined) return row[k]; } return null; };

// ===== Backend helper =====
const buildURL = (base, obj={}) => { const u=new URL(base); Object.entries(obj).forEach(([k,v])=>u.searchParams.set(k,v)); return u.toString(); };
async function getJSON(url){ try{ console.log('Fetching:', url); const r=await fetch(url,{cache:'no-store'}); if(!r.ok) throw new Error('HTTP '+r.status); return await r.json(); }catch(e){ console.error('Fetch error:', e); throw e; } }
async function postJSON(url, payload){ const r=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}); return r.json().catch(()=>({})); }

// ===== UI status helpers =====
function setStatus(type,msg){
  const dot = byId('dot'); const statusText = byId('statusText');
  if(!dot || !statusText) return;
  dot.classList.remove('ok','fail','load');
  if(type==='ok') dot.classList.add('ok'); else if(type==='fail') dot.classList.add('fail'); else dot.classList.add('load');
  statusText.textContent = msg||'';
}

// ===== Navigation =====
const show = id => { ['secForm','secDash','secInsights','secDailyScores'].forEach(x=> { const el=byId(x); if(el) el.style.display = (x===id)?'block':'none'; }); };
onReady(()=>{
  bind('navForm','click', ()=>{ show('secForm'); });
  bind('navDash','click', ()=> show('secDash'));
  bind('navInsight','click', ()=> show('secInsights'));
  bind('navDailyScores','click', ()=> { show('secDailyScores'); loadDailyScores(); });
  bind('btnEditProfile','click', ()=> show('secForm'));
  bind('btnReset','click', resetAllSettings);
  bind('btnClearURL','click', clearURLSettings);
  bind('btnEditTeams','click', ()=> { show('secForm'); });
  bind('btnQuickHearts','click', updateHeartsQuickly);
  bind('btnGoDailyScores','click', ()=> { show('secDailyScores'); loadDailyScores(); });
  bind('btnBackToInsightsFromDaily','click', ()=> show('secInsights'));
});

// ===== Start flow & auto-continue =====
let ctx={urlA:'',urlB:'',limit:50, interval:20000, cache:{A:{},B:{}}};
(function autoStart(){
  onReady(()=>{
    const done = localStorage.getItem('gs_profile_done')==='1';
    const currentWebapp = byId('webapp')?.value.trim() || '';
    const currentWebappA = byId('webappA')?.value.trim() || '';
    const currentWebappB = byId('webappB')?.value.trim() || '';
    const savedWebapp = localStorage.getItem('gs_webapp');
    const savedWebappA = localStorage.getItem('gs_webappA');
    const savedWebappB = localStorage.getItem('gs_webappB');
    const urlsChanged = (currentWebapp !== savedWebapp) || (currentWebappA !== savedWebappA) || (currentWebappB !== savedWebappB);
    let urlA = localStorage.getItem('gs_last_urlA')||''; let urlB = localStorage.getItem('gs_last_urlB')||'';
    const limit = +(localStorage.getItem('gs_last_limit')||50);
    const interval = +(localStorage.getItem('gs_last_interval')||20000);
    const demo = localStorage.getItem('gs_last_demo')==='on';
    const teamNameA = localStorage.getItem('gs_teamNameA') || '‡∏ó‡∏µ‡∏° A';
    const teamNameB = localStorage.getItem('gs_teamNameB') || '‡∏ó‡∏µ‡∏° B';
    updateTeamName('A', teamNameA); updateTeamName('B', teamNameB);
    if(done && (urlA || urlB) && !urlsChanged){
      if(!urlA && urlB) urlA=urlB; if(!urlB && urlA) urlB=urlA;
      ctx={urlA,urlB,limit,interval,cache:{A:{},B:{}}};
      try{ byId('dsA') && (byId('dsA').textContent= demo? 'DEMO' : (new URL(urlA)).host); }catch(e){}
      try{ byId('dsB') && (byId('dsB').textContent= demo? 'DEMO' : (new URL(urlB)).host); }catch(e){}
      const navForm = byId('navForm'); if(navForm) navForm.style.display='none';
      const btnEdit = byId('btnEditProfile'); if(btnEdit) btnEdit.style.display='inline-flex';
      const profBadge = byId('profileBadge'); if(profBadge) profBadge.style.display='inline-flex';
      byId('btnClearURL').style.display = 'inline-flex';
      byId('navDailyScores').style.display = 'inline-flex';
      show('secDash'); startDashboard(); setupTeamNameEditing();
    } else if (urlsChanged) {
      show('secForm'); byId('btnClearURL').style.display = 'inline-flex';
      setStatus('info','‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á URL - ‡∏Å‡∏î "‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó');
    }
  });
})();

// ===== Buttons =====
onReady(()=>{
  bind('btnTest','click', async ()=>{
    const baseA = (byId('webappA')?.value.trim()||byId('webapp')?.value.trim()||'');
    if(!baseA){ setStatus('fail','‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏™‡πà URL'); return; }
    try{ new URL(baseA); }catch(_){ setStatus('fail','URL ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); return; }
    setStatus('load','‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‚Ä¶');
    try{
      const ping = await getJSON(buildURL(baseA,{action:'ping'}));
      if(ping && ping.ok) setStatus('ok','‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ ‚úî ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô: ' + (ping.version || '2.2'));
      else setStatus('fail','‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
    }catch(e){ console.error('Connection test failed:', e); setStatus('fail','‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ' + e.message); }
  });

  bind('btnStart','click', async ()=>{
    const base = byId('webapp')?.value.trim()||'';
    const baseA = byId('webappA')?.value.trim()||'';
    const baseB = byId('webappB')?.value.trim()||'';
    const demo = byId('demo')?.value==='on';
    if(!demo && !base && !(baseA && baseB)){ setStatus('fail','‡πÉ‡∏™‡πà Web App URL ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏î‡∏™‡∏≠‡∏ö'); return; }
    const urlA = demo? 'demo://A' : (baseA || base);
    const urlB = demo? 'demo://B' : (baseB || base);
    if(!demo){ try{ new URL(urlA); new URL(urlB); }catch(_){ setStatus('fail','URL ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); return; } }

    const pf = { action:'saveProfile', name:byId('name')?.value.trim()||'', plant:byId('plant')?.value.trim()||'', size:byId('size')?.value.trim()||'', light:byId('lightCond')?.value, airflow:byId('airflow')?.value, ac:byId('ac')?.value };
    setStatus('load','‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‚Ä¶');
    if(!demo){ try{ await Promise.allSettled([ postJSON(urlA,{...pf,team:'A'}), postJSON(urlB,{...pf,team:'B'}) ]); }catch(e){ console.warn('Profile save warning:', e); } }

    const teamNameA = byId('teamNameA')?.value.trim() || '‡∏ó‡∏µ‡∏° A';
    const teamNameB = byId('teamNameB')?.value.trim() || '‡∏ó‡∏µ‡∏° B';
    localStorage.setItem('gs_teamNameA', teamNameA);
    localStorage.setItem('gs_teamNameB', teamNameB);
    updateTeamName('A', teamNameA); updateTeamName('B', teamNameB);

    localStorage.setItem('gs_webapp', base); localStorage.setItem('gs_webappA', baseA); localStorage.setItem('gs_webappB', baseB);
    localStorage.setItem('gs_last_urlA', urlA); localStorage.setItem('gs_last_urlB', urlB);
    localStorage.setItem('gs_last_limit', String(Number(byId('limit')?.value||50)));
    localStorage.setItem('gs_last_interval', String(Number(byId('interval')?.value||20)*1000));
    localStorage.setItem('gs_last_demo', demo?'on':'off'); localStorage.setItem('gs_profile_done','1');

    const navForm = byId('navForm'); if(navForm) navForm.style.display='none';
    const btnEdit = byId('btnEditProfile'); if(btnEdit) btnEdit.style.display='inline-flex';
    const profBadge = byId('profileBadge'); if(profBadge) profBadge.style.display='inline-flex';
    byId('btnClearURL').style.display = 'inline-flex';
    byId('navDailyScores').style.display = 'inline-flex';

    ctx={ urlA,urlB, limit:Number(byId('limit')?.value||50), interval:Number(byId('interval')?.value||20)*1000, cache:{A:{},B:{}} };
    try{ byId('dsA') && (byId('dsA').textContent = (demo? 'DEMO' : (new URL(urlA)).host)); }catch(e){}
    try{ byId('dsB') && (byId('dsB').textContent = (demo? 'DEMO' : (new URL(urlB)).host)); }catch(e){}
    setStatus('ok','‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß - ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
    show('secDash'); startDashboard(); setupTeamNameEditing();
  });

  bind('btnGoInsights','click', async ()=>{
    show('secInsights');
    renderInsights();
  });

  bind('btnBackDash','click', ()=> show('secDash'));
  bind('btnRefresh','click', ()=> { setStatus('load','‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä...'); tickOnce().finally(() => setStatus('ok','‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÅ‡∏•‡πâ‡∏ß')); });
  
  // AI Advice button
  bind('btnGetAIAdvice','click', async ()=>{
    setStatus('load','‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏à‡∏≤‡∏Å AI...');
    try {
      await getAIAdviceForBothTeams();
      setStatus('ok','‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏à‡∏≤‡∏Å AI ‡πÅ‡∏•‡πâ‡∏ß');
    } catch (error) {
      console.error('AI Advice error:', error);
      setStatus('fail','‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ç‡∏≠‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏à‡∏≤‡∏Å AI ‡πÑ‡∏î‡πâ');
    }
  });

  // Daily Scores buttons
  bind('btnManualSave','click', async () => {
    setStatus('load', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô...');
    try {
      const response = await getJSON(buildURL(ctx.urlA, {action: 'save_daily_scores'}));
      if (response.ok) {
        setStatus('ok', response.message || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        loadDailyScores();
      } else {
        setStatus('fail', response.message || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      }
    } catch (error) {
      console.error('Manual save error:', error);
      setStatus('fail', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + error.message);
    }
  });

  bind('btnRefreshDaily','click', () => {
    loadDailyScores();
  });
});

// ===== AI Advice Functions =====
async function getAIAdvice(team) {
  try {
    const url = team === 'A' ? ctx.urlA : ctx.urlB;
    if (url.startsWith('demo://')) {
      return "üí° ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏à‡∏≤‡∏Å AI (‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏î‡∏™‡∏≠‡∏ö): \n- ‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°\n- ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏î‡∏¥‡∏ô‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ ‡∏Ñ‡∏ß‡∏£‡∏£‡∏î‡∏ô‡πâ‡∏≥‡πÄ‡∏û‡∏¥‡πà‡∏°\n- ‡πÅ‡∏™‡∏á‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï\n- ‡∏£‡∏∞‡∏î‡∏±‡∏ö PM2.5 ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏î‡∏µ\n\n‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏£‡∏î‡∏ô‡πâ‡∏≥‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏¢‡∏≠‡∏≤‡∏Å‡∏≤‡∏®";
    }
    
    const aiUrl = buildURL(url, {action: 'ai_advice', team: team, limit: 50});
    const response = await getJSON(aiUrl);
    
    if (response && response.ok) {
      return response.advice || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏à‡∏≤‡∏Å AI ‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ";
    } else {
      return "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö AI ‡πÑ‡∏î‡πâ: " + (response?.error || "Unknown error");
    }
  } catch (error) {
    console.error('AI Advice error:', error);
    return "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏à‡∏≤‡∏Å AI: " + error.message;
  }
}

async function getAIAdviceForBothTeams() {
  const aiAdviceA = byId('aiAdviceA');
  const aiAdviceB = byId('aiAdviceB');
  const aiContentA = byId('aiAdviceContentA');
  const aiContentB = byId('aiAdviceContentB');
  
  aiAdviceA.className = 'ai-advice collapsed';
  aiAdviceB.className = 'ai-advice collapsed';
  
  aiAdviceA.querySelector('.ai-advice-toggle i').className = 'fa-solid fa-chevron-down';
  aiAdviceB.querySelector('.ai-advice-toggle i').className = 'fa-solid fa-chevron-down';
  
  aiAdviceA.style.display = 'block';
  aiAdviceB.style.display = 'block';
  
  aiContentA.innerHTML = '<div class="ai-loading"><div class="spinner"></div>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏à‡∏≤‡∏Å AI...</div>';
  aiContentB.innerHTML = '<div class="ai-loading"><div class="spinner"></div>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏à‡∏≤‡∏Å AI...</div>';
  
  try {
    const [adviceA, adviceB] = await Promise.all([
      getAIAdvice('A'),
      getAIAdvice('B')
    ]);
    
    aiContentA.textContent = adviceA;
    aiContentB.textContent = adviceB;
  } catch (error) {
    aiContentA.textContent = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message;
    aiContentB.textContent = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message;
  }
}

// ===== Demo generators =====
function demoRows(){
  const now=Date.now();
  const mk = i=>({
    'Timestamp (Asia/Bangkok)': new Date(now - i*60000).toISOString(),
    'Temperature (¬∞C)': +(25+Math.sin(i/6)*2).toFixed(1),
    'Air Humidity (%)': 55+((i*7)%10),
    'Soil Moisture (%)': 40+((i*5)%20),
    'Light (%)': 60+((i*3)%20),
    'PM2.5 (¬µg/m¬≥)': 22+((i*13)%40)
  });
  return Array.from({length:50},(_,i)=>mk(i));
}

function demoScores(){
  const now=Date.now();
  const scores = [];
  for (let i = 0; i < 20; i++) {
    const score = 5 + Math.round(Math.sin(i/3)*3);
    scores.push({
      'Timestamp': new Date(now - i*3600000).toISOString(),
      'Score': score,
      'Hearts': '‚ù§Ô∏è'.repeat(Math.max(1, Math.min(10, score))),
      'SpecialHearts': score >= 7 ? 'üíñ'.repeat(score) : '‚ù§Ô∏è'.repeat(score),
      'Advice': '‡∏£‡∏î‡∏ô‡πâ‡∏≥‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢/‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏™‡∏á',
      'Status': score >= 9 ? '‡∏î‡∏µ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏° üéâ' : score >= 7 ? '‡∏î‡∏µ‡∏°‡∏≤‡∏Å üëç' : score >= 5 ? '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á ‚úÖ' : '‡∏ï‡πâ‡∏≠‡∏á‡∏î‡∏π‡πÅ‡∏• ‚ö†Ô∏è'
    });
  }
  return scores;
}

// ===== Heart status functions =====
function updateStatusBadge(team, score) {
  const badge = byId(`${team}_status`);
  if (!badge) return;
  
  badge.className = 'status-badge ';
  if (score >= 9) {
    badge.classList.add('status-excellent');
    badge.textContent = '‡∏î‡∏µ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏° üéâ';
  } else if (score >= 7) {
    badge.classList.add('status-good');
    badge.textContent = '‡∏î‡∏µ‡∏°‡∏≤‡∏Å üëç';
  } else if (score >= 5) {
    badge.classList.add('status-fair');
    badge.textContent = '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á ‚úÖ';
  } else if (score >= 3) {
    badge.classList.add('status-poor');
    badge.textContent = '‡∏ï‡πâ‡∏≠‡∏á‡∏î‡∏π‡πÅ‡∏• ‚ö†Ô∏è';
  } else {
    badge.classList.add('status-critical');
    badge.textContent = '‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢ üö®';
  }
}

// ===== Dashboard polling =====
async function pack(url, team, limit){
  if(url.startsWith('demo://')) { 
    return { 
      data: demoRows(), 
      score: demoScores(),
      hearts: { score: 7, hearts: '‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è', special_hearts: 'üíñüíñüíñüíñüíñüíñüíñ', status: '‡∏î‡∏µ‡∏°‡∏≤‡∏Å üëç' }
    }; 
  }
  try {
    const dataUrl = buildURL(url,{action:'data',team,limit});
    const scoreUrl = buildURL(url,{action:'score',team,limit:10});
    const heartsUrl = buildURL(url,{action:'get_hearts',team});
    
    const [dRes, sRes, hRes] = await Promise.allSettled([ 
      getJSON(dataUrl), 
      getJSON(scoreUrl),
      getJSON(heartsUrl)
    ]);
    
    return { 
      data: dRes.status==='fulfilled' ? (dRes.value.rows||[]) : [], 
      score: sRes.status==='fulfilled'? (sRes.value.scores||[]) : [],
      hearts: hRes.status==='fulfilled'? hRes.value : null
    };
  } catch(e) { 
    console.error(`Pack error for ${team}:`, e); 
    return { data: [], score: [], hearts: null }; 
  }
}

async function renderTeam(url, team, prefix){
  try{
    const {data, score, hearts} = await pack(url, team, ctx.limit);
    ctx.cache[team] = {data, score};
    
    if(data.length > 0){
      const latest = data[0];
      const tC = safeNum(pick(latest, COLS.tC));
      const rh = safeNum(pick(latest, COLS.rh));
      const soil = safeNum(pick(latest, COLS.soil));
      const light = safeNum(pick(latest, COLS.light));
      setTextSafe(prefix+'temp', tC != null ? tC.toFixed(1) : '-');
      setTextSafe(prefix+'hum', rh != null ? rh : '-');
      setTextSafe(prefix+'soil', soil != null ? soil : '-');
      setTextSafe(prefix+'light', light != null ? light : '-');
      
      const tb = byId(prefix+'tbl');
      if(tb){
        tb.innerHTML = '';
        data.slice(0, 8).forEach(row => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${fmtTime(pick(row, COLS.ts))}</td>
            <td style="text-align:center">${pick(row, COLS.tC) ?? '-'}</td>
            <td style="text-align:center">${pick(row, COLS.rh) ?? '-'}</td>
            <td style="text-align:center">${pick(row, COLS.soil) ?? '-'}</td>
            <td style="text-align:center">${pick(row, COLS.light) ?? '-'}</td>
          `;
          tb.appendChild(tr);
        });
      }
    }
    
    if (hearts && hearts.ok) {
      setTextSafe(prefix+'hearts', hearts.hearts || '‚Äî');
      setTextSafe(prefix+'special_hearts', hearts.special_hearts || '');
      updateStatusBadge(team.charAt(0), hearts.score || 5);
    } else if(score.length > 0){
      const latestScore = score[0];
      const scoreValue = safeNum(pick(latestScore, SCORE.score)) || 0;
      const hearts = pick(latestScore, SCORE.hearts);
      const specialHearts = pick(latestScore, SCORE.special_hearts);
      const status = pick(latestScore, SCORE.status);
      
      setTextSafe(prefix+'hearts', hearts || '‚ù§Ô∏è'.repeat(Math.max(1, Math.min(10, scoreValue))));
      setTextSafe(prefix+'special_hearts', specialHearts || '');
      updateStatusBadge(team.charAt(0), scoreValue);
      
      const advice = pick(latestScore, SCORE.advice);
      setTextSafe(prefix+'advice', advice ? `‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ${advice}` : '‚Äî');
    } else {
      setTextSafe(prefix+'hearts', '‚Äî'); 
      setTextSafe(prefix+'special_hearts', '');
      setTextSafe(prefix+'advice', '‚Äî');
      updateStatusBadge(team.charAt(0), 5);
    }
  } catch(e){
    console.error(`Render error for ${team}:`, e);
    setTextSafe(prefix+'hearts', '‚Äî'); 
    setTextSafe(prefix+'special_hearts', '');
    setTextSafe(prefix+'advice', '‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    updateStatusBadge(team.charAt(0), 5);
  }
}

async function updateHeartsQuickly() {
  setStatus('load', '‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏´‡∏±‡∏ß‡πÉ‡∏à...');
  try {
    const [heartsA, heartsB] = await Promise.all([
      getJSON(buildURL(ctx.urlA, {action: 'get_hearts', team: 'A'})),
      getJSON(buildURL(ctx.urlB, {action: 'get_hearts', team: 'B'}))
    ]);
    
    if (heartsA.ok) {
      setTextSafe('a_hearts', heartsA.hearts || '‚Äî');
      setTextSafe('a_special_hearts', heartsA.special_hearts || '');
      updateStatusBadge('a', heartsA.score || 5);
    }
    
    if (heartsB.ok) {
      setTextSafe('b_hearts', heartsB.hearts || '‚Äî');
      setTextSafe('b_special_hearts', heartsB.special_hearts || '');
      updateStatusBadge('b', heartsB.score || 5);
    }
    
    setStatus('ok', '‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
  } catch (e) {
    console.error('Quick hearts update error:', e);
    setStatus('fail', '‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
  }
}

async function tickOnce(){ 
  try { 
    await Promise.all([ 
      renderTeam(ctx.urlA,'A','a_'), 
      renderTeam(ctx.urlB,'B','b_') 
    ]); 
  } catch(e) { 
    console.error('Tick error:', e); 
  } 
}

let timer = null;
async function startDashboard(){ 
  await tickOnce(); 
  if(timer) clearInterval(timer); 
  timer = setInterval(() => { 
    tickOnce().catch(e => console.error('Interval tick error:', e)); 
  }, ctx.interval || 20000); 
}

// ===== Daily Scores Management =====
let dailyScoresChart = null;

async function loadDailyScores() {
  setTextSafe('lastUpdateText', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...');
  
  try {
    const response = await getJSON(buildURL(ctx.urlA, {action: 'get_daily_scores', days: 60}));
    
    if (response.ok && response.scores) {
      renderDailyScores(response.scores);
      setTextSafe('lastUpdateText', `‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${new Date().toLocaleString('th-TH', {timeZone: tz})}`);
    } else {
      throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡πÑ‡∏î‡πâ');
    }
  } catch (error) {
    console.error('Load daily scores error:', error);
    setTextSafe('lastUpdateText', '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
    setStatus('fail', '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
  }
}

function renderDailyScores(scores) {
  const teamAScores = scores.filter(score => score.‡∏ó‡∏µ‡∏° === 'A');
  const teamBScores = scores.filter(score => score.‡∏ó‡∏µ‡∏° === 'B');
  
  teamAScores.sort((a, b) => new Date(a.‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà) - new Date(b.‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà));
  teamBScores.sort((a, b) => new Date(a.‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà) - new Date(b.‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà));
  
  updateTeamStats('A', teamAScores);
  updateTeamStats('B', teamBScores);
  
  renderDailyScoresChart(teamAScores, teamBScores);
  renderDailyScoresTable(scores);
}

function updateTeamStats(team, scores) {
  if (scores.length === 0) {
    setTextSafe(`team${team}Stats`, '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
    return;
  }
  
  const latestScore = scores[scores.length - 1];
  const avgScore = scores.reduce((sum, score) => sum + parseFloat(score['‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢']), 0) / scores.length;
  const maxScore = Math.max(...scores.map(score => parseFloat(score['‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î'])));
  const minScore = Math.min(...scores.map(score => parseFloat(score['‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î'])));
  const totalDataPoints = scores.reduce((sum, score) => sum + parseInt(score['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•']), 0);
  
  const statsHTML = `
    <div style="margin-bottom: 8px;">
      <strong>‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (${latestScore.‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà}):</strong> ${latestScore['‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢']} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
      <span class="status-badge ${getStatusClass(latestScore.‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞)}">${latestScore.‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞}</span>
    </div>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 13px;">
      <div>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢: <strong>${avgScore.toFixed(2)}</strong></div>
      <div>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: <strong>${maxScore.toFixed(1)}</strong></div>
      <div>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î: <strong>${minScore.toFixed(1)}</strong></div>
      <div>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô: <strong>${scores.length}</strong></div>
    </div>
    <div style="margin-top: 8px; font-size: 12px; color: var(--muted);">
      ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${totalDataPoints} ‡∏à‡∏∏‡∏î
    </div>
  `;
  
  setTextSafe(`team${team}Stats`, '');
  byId(`team${team}Stats`).innerHTML = statsHTML;
}

function getStatusClass(status) {
  if (status.includes('‡∏î‡∏µ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°')) return 'status-excellent';
  if (status.includes('‡∏î‡∏µ‡∏°‡∏≤‡∏Å')) return 'status-good';
  if (status.includes('‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á')) return 'status-fair';
  if (status.includes('‡∏ï‡πâ‡∏≠‡∏á‡∏î‡∏π‡πÅ‡∏•')) return 'status-poor';
  return 'status-critical';
}

function renderDailyScoresChart(teamAScores, teamBScores) {
  const canvas = byId('chartDailyScores');
  if (!canvas) return;
  
  const ctx = canvas.getContext('2d');
  if (dailyScoresChart) dailyScoresChart.destroy();
  
  const labels = teamAScores.map(score => {
    const date = new Date(score.‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà);
    return date.toLocaleDateString('th-TH', {timeZone: tz, day: '2-digit', month: 'short'});
  });
  
  const dataA = teamAScores.map(score => parseFloat(score['‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢']));
  const dataB = teamBScores.map(score => parseFloat(score['‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢']));
  
  dailyScoresChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [
        {
          label: byId('teamANameDisplay').textContent,
          data: dataA,
          borderColor: '#10b981',
          backgroundColor: '#10b98120',
          tension: 0.3,
          fill: false
        },
        {
          label: byId('teamBNameDisplay').textContent,
          data: dataB,
          borderColor: '#8b5cf6',
          backgroundColor: '#8b5cf620',
          tension: 0.3,
          fill: false
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          display: true,
          position: 'top'
        },
        tooltip: {
          mode: 'index',
          intersect: false
        }
      },
      scales: {
        y: {
          min: 0,
          max: 10,
          ticks: {
            stepSize: 1
          },
          title: {
            display: true,
            text: '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô'
          }
        },
        x: {
          title: {
            display: true,
            text: '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'
          }
        }
      }
    }
  });
}

function renderDailyScoresTable(scores) {
  const tableBody = byId('dailyScoresTable');
  if (!tableBody) return;
  
  const sortedScores = [...scores].sort((a, b) => new Date(b.‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà) - new Date(a.‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà));
  
  if (sortedScores.length === 0) {
    tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;" class="muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</td></tr>';
    return;
  }
  
  let html = '';
  sortedScores.forEach(score => {
    const statusClass = getStatusClass(score.‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞);
    html += `
      <tr>
        <td>${score.‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà}</td>
        <td style="text-align: center;">‡∏ó‡∏µ‡∏° ${score.‡∏ó‡∏µ‡∏°}</td>
        <td style="text-align: center;"><strong>${score['‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢']}</strong></td>
        <td style="text-align: center;">${score['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•']}</td>
        <td style="text-align: center;">${score['‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î']}</td>
        <td style="text-align: center;">${score['‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î']}</td>
        <td style="text-align: center;"><span class="status-badge ${statusClass}">${score.‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞}</span></td>
      </tr>
    `;
  });
  
  tableBody.innerHTML = html;
}

// ===== Insights =====
let heartChart = null;
function renderInsights(){
  try {
    const A = (ctx.cache.A.score || []).map(o => ({ ts: pick(o, SCORE.ts), s: +(pick(o, SCORE.score) || 0) })).slice(0, 30).reverse();
    const B = (ctx.cache.B.score || []).map(o => ({ ts: pick(o, SCORE.ts), s: +(pick(o, SCORE.score) || 0) })).slice(0, 30).reverse();
    const labels = (A.length > 0 ? A : B).map(x => x.ts ? new Date(x.ts).toLocaleTimeString('th-TH',{ timeZone: tz, hour: '2-digit', minute: '2-digit' }) : '');
    const dataA = A.map(x => x.s); const dataB = B.map(x => x.s);

    const canvas = byId('chartHearts'); if(!canvas) return;
    const ctx2 = canvas.getContext('2d'); if(heartChart) heartChart.destroy();
    heartChart = new Chart(ctx2, {
      type: 'line',
      data: { labels, datasets: [
        { label: byId('teamANameDisplay').textContent, data: dataA, tension: 0.25, pointRadius: 2, borderWidth: 2, borderColor: '#10b981', backgroundColor: '#10b98120', fill: false },
        { label: byId('teamBNameDisplay').textContent, data: dataB, tension: 0.25, pointRadius: 2, borderWidth: 2, borderColor: '#8b5cf6', backgroundColor: '#8b5cf620', fill: false }
      ]},
      options: { responsive:true, scales:{ y:{ suggestedMin:0, suggestedMax:10, ticks:{ stepSize:1 } } }, plugins:{ legend:{display:true}, tooltip:{enabled:true} } }
    });

    byId('healthA') && (byId('healthA').innerHTML = healthHTML(latestEnv('A')));
    byId('healthB') && (byId('healthB').innerHTML = healthHTML(latestEnv('B')));
    byId('dailyTable') && (byId('dailyTable').innerHTML = tableSummary(avgBy('day')));
    byId('weeklyTable') && (byId('weeklyTable').innerHTML = tableSummary(avgBy('week')));
  } catch(e) { console.error('Render insights error:', e); }
}

function latestEnv(team){
  const rows = (team === 'A' ? ctx.cache.A.data : ctx.cache.B.data);
  if(!rows || !rows.length) return null;
  const r = rows[0];
  return { 
    ts: pick(r, COLS.ts), 
    tC: safeNum(pick(r, COLS.tC)), 
    rh: safeNum(pick(r, COLS.rh)), 
    pm25: safeNum(pick(r, COLS.pm25)), 
    light: safeNum(pick(r, COLS.light))
  };
}

function pm25Cat(v){
  if(v == null) return {cat: '‚Äî', tip: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• PM2.5'};
  if(v <= 25) return {cat: '‡∏î‡∏µ‡∏°‡∏≤‡∏Å', tip: '‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏î‡∏µ ‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÑ‡∏î‡πâ'};
  if(v <= 37) return {cat: '‡∏î‡∏µ', tip: '‡∏ó‡∏≥‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥'};
  if(v <= 50) return {cat: '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á', tip: '‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÇ‡∏£‡∏Ñ‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡∏Ñ‡∏ß‡∏£‡∏•‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏´‡∏ô‡∏±‡∏Å'};
  if(v <= 90) return {cat: '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏°‡∏µ‡∏ú‡∏•', tip: '‡∏™‡∏ß‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ô‡∏≤‡∏ô'};
  return {cat: '‡∏°‡∏µ‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö', tip: '‡∏Ñ‡∏ß‡∏£‡∏™‡∏ß‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏Å/‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á‡∏≠‡∏≤‡∏Å‡∏≤‡∏®'};
}

function lightTip(light){
  if(light == null) return '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏™‡∏á';
  if(light < 30) return '‡πÅ‡∏™‡∏á‡∏ô‡πâ‡∏≠‡∏¢ ‚Äî ‡∏Ç‡∏¢‡∏±‡∏ö‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏õ‡∏•‡∏π‡∏Å';
  if(light < 50) return '‡πÅ‡∏™‡∏á‡∏û‡∏≠‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ‚Äî ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏∑‡∏ä‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏´‡∏ç‡πà';
  if(light < 70) return '‡πÅ‡∏™‡∏á‡∏î‡∏µ ‚Äî ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï';
  if(light < 85) return '‡πÅ‡∏™‡∏á‡πÅ‡∏£‡∏á ‚Äî ‡πÉ‡∏ä‡πâ‡∏°‡πà‡∏≤‡∏ô‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏™‡∏á‡∏´‡∏≤‡∏Å‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô';
  return '‡πÅ‡∏™‡∏á‡πÅ‡∏£‡∏á‡∏°‡∏≤‡∏Å ‚Äî ‡∏≠‡∏≤‡∏à‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏£‡∏≤‡∏á‡πÅ‡∏™‡∏á';
}

function healthHTML(env){
  if(!env) return '<div class="muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
  const pm = pm25Cat(env.pm25);
  const humidTip = env.rh != null ? (env.rh < 40 ? '‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡πÅ‡∏´‡πâ‡∏á ‚Äî ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô' : env.rh > 70 ? '‡∏≠‡∏±‡∏ö‡∏ä‡∏∑‡πâ‡∏ô ‚Äî ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ñ‡πà‡∏≤‡∏¢‡πÄ‡∏ó' : '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°') : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô';
  const tempTip = env.tC != null ? (env.tC < 22 ? '‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡πÄ‡∏¢‡πá‡∏ô ‚Äî ‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏•‡∏°‡πÄ‡∏¢‡πá‡∏ô‡∏à‡∏±‡∏î' : env.tC > 30 ? '‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏£‡πâ‡∏≠‡∏ô ‚Äî ‡∏£‡∏∞‡∏ö‡∏≤‡∏¢‡∏≠‡∏≤‡∏Å‡∏≤‡∏®' : '‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°') : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥';
  return `
    <div class="chips">
      <span class="chip">‡πÄ‡∏ß‡∏•‡∏≤: ${fmtTime(env.ts)}</span>
      <span class="chip">PM2.5: ${env.pm25 ?? '‚Äî'} ¬µg/m¬≥ (${pm.cat})</span>
      <span class="chip">RH: ${env.rh ?? '‚Äî'}%</span>
      <span class="chip">Temp: ${env.tC ?? '‚Äî'}¬∞C</span>
      <span class="chip">Light: ${env.light ?? '‚Äî'}%</span>
    </div>
    <div style="margin-top:8px">
      <div><strong>‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏î‡πâ‡∏≤‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û:</strong></div>
      <ul style="margin:6px 0 0 18px; font-size:14px;">
        <li>${pm.tip}</li>
        <li>${humidTip}</li>
        <li>${tempTip}</li>
        <li>${lightTip(env.light)}</li>
      </ul>
    </div>
  `;
}

function avgBy(kind){
  const coll = (rows) => (rows || []).map(o => ({ d: kind === 'day' ? fmtDate(pick(o, SCORE.ts)) : weekKey(pick(o, SCORE.ts)), s: +(pick(o, SCORE.score) || 0) }));
  const A = coll(ctx.cache.A.score); const B = coll(ctx.cache.B.score);
  const agg = (arr) => arr.reduce((m, x) => { (m[x.d] = m[x.d] || []).push(x.s); return m; }, {});
  const avg = (obj) => Object.entries(obj).map(([d, vals]) => ({ date:d, avg:+(vals.reduce((a,b)=>a+b,0)/vals.length).toFixed(2) })).sort((a,b)=>a.date.localeCompare(b.date));
  return { A: avg(agg(A)), B: avg(agg(B)) };
}

function weekKey(iso){
  if(!iso) return '-'; const d=new Date(iso); const y=d.getFullYear(); const firstDay=new Date(y,0,1);
  const days=Math.floor((d-firstDay)/86400000)+firstDay.getDay()+1; const w=Math.floor(days/7);
  return `${y}-W${('0'+w).slice(-2)}`;
}

function tableSummary(obj){
  const keys = Array.from(new Set([ ...(obj.A||[]).map(x=>x.date), ...(obj.B||[]).map(x=>x.date) ])).sort();
  if(keys.length===0) return '<div class="muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
  let html = `<table style="width:100%; font-size:11px;"><thead><tr><th style="text-align:left">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</th><th>${byId('teamANameDisplay').textContent}</th><th>${byId('teamBNameDisplay').textContent}</th></tr></thead><tbody>`;
  keys.forEach(k => {
    const a = (obj.A||[]).find(x=>x.date===k)?.avg ?? '-';
    const b = (obj.B||[]).find(x=>x.date===k)?.avg ?? '-';
    html += `<tr><td>${k}</td><td style="text-align:center">${a}</td><td style="text-align:center">${b}</td></tr>`;
  });
  html += `</tbody></table>`; return html;
}

// ===== Self-tests =====
function runSelfTests(){
  const mustHave = ['nowTH','theme','navDash','secDash','chartHearts','a_tbl','b_tbl','btnStart'];
  const miss = mustHave.filter(id => !byId(id));
  if(miss.length > 0) console.warn('Missing elements:', miss);
}
onReady(() => { runSelfTests(); console.log('GreenSync Duel with Daily Scores loaded successfully'); });
</script>
</body>
</html>